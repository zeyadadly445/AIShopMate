# ุฏููู ุงูุชุทุจูู ุงูุขูู ูู SQL - ูุธุงู ุชุฎุตูุต ูุธูุฑ ุงูุดุงุช

## ๐ ุถูุงูุงุช ุงูุฃูุงู ุงููุฏูุฌุฉ

### โ **ุงูุถูุงูุงุช ุงููุคูุฏุฉ:**
1. **ุนุฏู ูุณุญ ุฃู ุจูุงูุงุช ููุฌูุฏุฉ** - ุฌููุน ุงูุนูููุงุช ุขููุฉ
2. **ุนุฏู ุชุนุฏูู ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ** - ุงููุธุงู ูููุตู ุชูุงูุงู
3. **ุญูุงูุฉ ููุงุนุฏ ุงูุจูุงูุงุช ุงูุญุงููุฉ** - Row Level Security ูุทุจู
4. **ุงูุชูุงูู ุงููุงูู** - ูุน ุงููุธุงู ุงูุญุงูู ุฏูู ุชุฏุงุฎู

---

## ๐ ุงููููุงุช ุงููุทููุจุฉ

### ููู SQL ุงูููุตู ุจู:
```
supabase-chat-customization-safe.sql
```

### ูููุงุช ุงููุธุงู:
- `app/api/chat-appearance/[chatbotId]/route.ts` โ **ูุญุฏุซ ููุชูุงูู**
- `app/customize/[chatbotId]/page.tsx` โ **ุฌุงูุฒ ููุงุณุชุฎุฏุงู**

---

## ๐ก๏ธ ุขููุงุช ุงูุญูุงูุฉ ุงููุฏูุฌุฉ ูู SQL

### 1. **ุญูุงูุฉ ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ:**
```sql
-- ููุท ุฅูุดุงุก ุฌุฏูู ุฌุฏูุฏ - ูุง ุชุนุฏูู ุนูู ุงูููุฌูุฏ
CREATE TABLE IF NOT EXISTS "ChatCustomization" (...)
```

### 2. **ุญูุงูุฉ ุงูุจูุงูุงุช:**
```sql
-- ุงูุชุญูู ูุจู ุญุฐู ุฃู ุดูุก
IF (SELECT COUNT(*) FROM "ChatCustomization") = 0 THEN
    DROP TABLE "ChatCustomization";
ELSE
    RAISE NOTICE 'ุฌุฏูู ChatCustomization ูุญุชูู ุนูู ุจูุงูุงุช - ุณูุชู ุชุฎุทู ุงูุญุฐู ููุญูุงูุฉ';
END IF;
```

### 3. **ุงุณุชุฎุฏุงู IF NOT EXISTS:**
```sql
-- ููุน ุงูุฃุฎุทุงุก ุฅุฐุง ูุงูุช ุงูุนูุงุตุฑ ููุฌูุฏุฉ ูุณุจูุงู
CREATE INDEX IF NOT EXISTS "idx_chatcustomization_merchantid" ...
ALTER TABLE ... ADD CONSTRAINT ... (ูุน ุงูุชุญูู ุฃููุงู)
```

### 4. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
```sql
EXCEPTION
    WHEN others THEN
        RAISE NOTICE 'ุฎุทุฃ ูู ุฅูุดุงุก ุงูุนูุงูุฉ ุงูุฎุงุฑุฌูุฉ: %', SQLERRM;
```

---

## ๐ง ุฎุทูุงุช ุงูุชุทุจูู ุงูุขููุฉ

### ุงููุฑุญูุฉ 1: ุงูุชุญุถูุฑ
1. **ูุณุฎ ุงุญุชูุงุทู** (ุงุฎุชูุงุฑู ูููู ููุตู ุจู):
   ```sql
   -- ูู Supabase Dashboard -> SQL Editor
   SELECT * FROM "Merchant" LIMIT 5; -- ุงูุชุฃูุฏ ูู ุงูุจูุงูุงุช
   ```

2. **ูุญุต ุงูุจููุฉ ุงูุญุงููุฉ:**
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public';
   ```

### ุงููุฑุญูุฉ 2: ุงูุชุทุจูู
1. **ูุณุฎ ูุญุชููุงุช** `supabase-chat-customization-safe.sql`
2. **ูุตู ูู Supabase SQL Editor**
3. **ุชุดุบูู ุงูุฃูุฑ** - ุณูุธูุฑ ุฑุณุงุฆู ุชุฃููุฏ ุฎุถุฑุงุก

### ุงููุฑุญูุฉ 3: ุงูุชุญูู
```sql
-- ุงูุชุญูู ูู ุฅูุดุงุก ุงูุฌุฏูู ุจูุฌุงุญ
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'ChatCustomization';

-- ุงูุชุญูู ูู ุงูุนูุงูุงุช
SELECT constraint_name, table_name, column_name, foreign_table_name
FROM information_schema.key_column_usage 
WHERE table_name = 'ChatCustomization';
```

---

## โ๏ธ ุญู ูุดููุฉ ุชุนุงุฑุถ ุงูุฃููุงุน

### ุงููุดููุฉ ุงูุฃุตููุฉ:
```
ERROR: 42804: foreign key constraint "ChatCustomization_merchantId_fkey" cannot be implemented
DETAIL: Key columns "merchantId" and "id" are of incompatible types: uuid and text.
```

### โ **ุงูุญู ุงููุทุจู:**
- **ุชุบููุฑ ููุน `merchantId`** ูู `UUID` ุฅูู `TEXT`
- **ุงูุชุทุงุจู ูุน** `Merchant.id` ุงูุฐู ูู `TEXT`
- **ุงูุญูุงุธ ุนูู** ุฌููุน ุงููุธุงุฆู ูุงูุฃูุงู

---

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ุจุนุฏ ุงูุชุทุจูู ุงููุงุฌุญ:
```
โ ุชู ุฅุนุฏุงุฏ ูุธุงู ุชุฎุตูุต ูุธูุฑ ุงูุดุงุช ุจูุฌุงุญ!
๐ ุฌููุน ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูุญููุธุฉ ูุขููุฉ
๐จ ูููู ุงูุขู ุงุณุชุฎุฏุงู ูุธุงู ุงูุชุฎุตูุต
```

### ุงูุฌุฏุงูู ุงูุฌุฏูุฏุฉ:
- `ChatCustomization` โ **ุฌุฏูู ุงูุชุฎุตูุตุงุช**
- **Functions** โ `get_merchant_customization()`, `update_chat_customization_updated_at()`
- **Triggers** โ ุชุญุฏูุซ `updatedAt` ุชููุงุฆูุงู
- **Policies** โ Row Level Security

---

## ๐ ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. **ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุชุฎุตูุต:**
```url
http://localhost:3000/customize/[chatbotId]
```

### 2. **ุงุฎุชุจุงุฑ API:**
```bash
# GET - ุชุญููู ุงูุชุฎุตูุตุงุช
curl http://localhost:3000/api/chat-appearance/[chatbotId]

# POST - ุญูุธ ุชุฎุตูุตุงุช ุฌุฏูุฏุฉ
curl -X POST http://localhost:3000/api/chat-appearance/[chatbotId] \
  -H "Content-Type: application/json" \
  -d '{"primaryColor": "#ff0000"}'
```

### 3. **ุงุฎุชุจุงุฑ ุตูุญุฉ ุงูุดุงุช:**
```url
http://localhost:3000/chat/[chatbotId]
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ุธูุฑ ุฎุทุฃ "ุฌุฏูู ููุฌูุฏ":
```sql
-- ุงูููุฏ ูุชุนุงูู ูุน ูุฐุง ุชููุงุฆูุงู
RAISE NOTICE 'ุงูุนูุงูุฉ ุงูุฎุงุฑุฌูุฉ ููุฌูุฏุฉ ูุณุจูุงู';
```

### ุฅุฐุง ุธูุฑ ุฎุทุฃ "ุตูุงุญูุงุช":
```sql
-- ุงูููุฏ ูุถูู ุงูุตูุงุญูุงุช ุชููุงุฆูุงู
GRANT SELECT, INSERT, UPDATE, DELETE ON "ChatCustomization" TO authenticated;
```

### ุฅุฐุง ูู ุชุธูุฑ ุงูุชุฎุตูุตุงุช:
- **ุชุญูู ูู** Row Level Security
- **ุชุฃูุฏ ูู** ุตุญุฉ `merchantId`
- **ุฑุงุฌุน** `browser console` ููุฃุฎุทุงุก

---

## ๐ ุงูุฏุนู ุงูููู

### ูู ุญุงูุฉ ูุฌูุฏ ูุดุงูู:
1. **ุชุญูู ูู ุฑุณุงุฆู SQL** ูู Supabase
2. **ุฑุงุฌุน console logs** ูู ุงููุชุตูุญ
3. **ุชุฃูุฏ ูู ุตุญุฉ** `chatbotId` ูู URL
4. **ุชุญูู ูู** `DATABASE_URL` ูู `.env.local`

### ุฅุนุงุฏุฉ ุงูุชุทุจูู (ุฅุฐุง ูุฒู ุงูุฃูุฑ):
```sql
-- ุญุฐู ุขูู ููุฌุฏูู ููุท ุฅุฐุง ูุงู ูุงุฑุบุงู
DROP TABLE IF EXISTS "ChatCustomization";
-- ุซู ุชุทุจูู SQL ูุฑุฉ ุฃุฎุฑู
```

---

## ๐ ููุฎุต ุงูุฃูุงู

| ุงูุนูุตุฑ | ุงูุญุงูุฉ | ุงูุถูุงู |
|---------|--------|---------|
| ุจูุงูุงุช Merchant | โ ูุญููุธุฉ | ูุง ุชูุณ |
| ุจูุงูุงุช Subscription | โ ูุญููุธุฉ | ูุง ุชูุณ |
| ุจูุงูุงุช Conversation | โ ูุญููุธุฉ | ูุง ุชูุณ |
| ุจูุงูุงุช Message | โ ูุญููุธุฉ | ูุง ุชูุณ |
| ุงูุฌุฏุงูู ุงูุฃุฎุฑู | โ ูุญููุธุฉ | ูุง ุชูุณ |
| **ูุธุงู ุงูุชุฎุตูุต** | โ **ุฌุฏูุฏ** | **ูููุตู ุชูุงูุงู** |

---

**๐ก ุงูุฎูุงุตุฉ:** ุงููุธุงู ูุตูู ููููู ุขููุงู 100% ููุง ููุณ ุฃู ุจูุงูุงุช ููุฌูุฏุฉ. ูุถูู ูุธุงุฆู ุฌุฏูุฏุฉ ููุท ุฏูู ุชุนุฏูู ุงูููุฌูุฏ. 